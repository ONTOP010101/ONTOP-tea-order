# 下单功能修复指南

## 问题描述
新电脑上无法正常下单，报错提示外键约束失败，原因是订单服务在创建订单时没有正确处理用户ID，导致引用了不存在的用户。

## 修复内容

### 1. 修改订单服务文件
**文件路径**: `apps/server/src/modules/order/order.service.ts`

**修改内容**:
- 添加 `UserService` 的导入
- 在构造函数中注入 `UserService`
- 确保下单时检查用户是否存在，不存在则创建默认用户

### 2. 修改订单模块文件
**文件路径**: `apps/server/src/modules/order/order.module.ts`

**修改内容**:
- 添加 `UserModule` 的导入
- 将 `UserModule` 添加到 `imports` 数组中

## 详细修复步骤

### 步骤1: 更新 order.service.ts

1. 在文件顶部添加导入:
```typescript
import { UserService } from '../user/user.service';
```

2. 在构造函数中添加注入:
```typescript
constructor(
  @InjectRepository(Order)
  private orderRepository: Repository<Order>,
  private orderGateway: OrderGateway,
  private productService: ProductService,
  private specService: SpecService,
  private userService: UserService, // 添加这一行
) {}
```

### 步骤2: 更新 order.module.ts

1. 在文件顶部添加导入:
```typescript
import { UserModule } from '../user/user.module';
```

2. 在 `imports` 数组中添加 `UserModule`:
```typescript
@Module({
  imports: [TypeOrmModule.forFeature([Order]), WebsocketModule, ProductModule, SpecModule, UserModule],
  controllers: [OrderController],
  providers: [OrderService],
  exports: [OrderService],
})
```

### 步骤3: 重新构建并启动服务

1. 进入 `apps/server` 目录
2. 运行构建命令:
   ```bash
   powershell -ExecutionPolicy Bypass -Command "npx nest build"
   ```
3. 启动后端服务:
   ```bash
   node dist/main
   ```

## 验证修复

1. 确保后端服务运行正常
2. 在H5客户端尝试下单
3. 检查订单是否成功创建，没有外键约束错误

## 注意事项

- 确保数据库中存在 `users` 表
- 确保后端服务端口配置正确
- 确保H5客户端的代理配置指向正确的后端服务地址

如果您在新电脑上使用的是完整的项目备份，这些修复应该已经包含在代码中。如果您是从远程仓库拉取的代码，请确保修复已经推送到远程仓库。