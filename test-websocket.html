<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocketæµ‹è¯•</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .log {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            color: green;
        }
        .error {
            color: red;
        }
        .info {
            color: blue;
        }
        button {
            margin: 5px;
            padding: 8px 16px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>WebSocketæµ‹è¯•é¡µé¢</h1>
    <div>
        <button onclick="connectWebSocket()">è¿æ¥WebSocket</button>
        <button onclick="disconnectWebSocket()">æ–­å¼€è¿æ¥</button>
        <button onclick="joinProductionRoom()">åŠ å…¥åˆ¶ä½œç«¯æˆ¿é—´</button>
        <button onclick="loadOrders()">åŠ è½½è®¢å•</button>
    </div>
    
    <h2>è¿æ¥çŠ¶æ€</h2>
    <div id="connectionStatus" class="log info">æœªè¿æ¥</div>
    
    <h2>äº‹ä»¶æ—¥å¿—</h2>
    <div id="eventLog" class="log"></div>
    
    <h2>è®¢å•åˆ—è¡¨</h2>
    <div id="orderList" class="log"></div>

    <script>
        let socket = null;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('eventLog');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<span class="${type}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function updateConnectionStatus(status, type = 'info') {
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.className = `log ${type}`;
            statusDiv.textContent = status;
        }
        
        function updateOrderList(orders) {
            const orderListDiv = document.getElementById('orderList');
            if (orders.length === 0) {
                orderListDiv.textContent = 'æš‚æ— è®¢å•';
                return;
            }
            
            let orderHtml = '';
            orders.forEach(order => {
                orderHtml += `è®¢å•å·: ${order.order_no}\n`;
                orderHtml += `çŠ¶æ€: ${order.status}\n`;
                orderHtml += `é‡‘é¢: Â¥${order.final_amount}\n`;
                orderHtml += `ä¸‹å•æ—¶é—´: ${new Date(order.created_at).toLocaleString()}\n`;
                orderHtml += '---\n';
            });
            orderListDiv.textContent = orderHtml;
        }
        
        function connectWebSocket() {
            log('å°è¯•è¿æ¥WebSocket...');
            
            socket = io('http://localhost:3003/order', {
                transports: ['websocket', 'polling'],
                reconnection: true
            });
            
            socket.on('connect', () => {
                log('âœ… WebSocketè¿æ¥æˆåŠŸ', 'success');
                updateConnectionStatus('å·²è¿æ¥', 'success');
            });
            
            socket.on('disconnect', (reason) => {
                log(`âŒ WebSocketæ–­å¼€è¿æ¥: ${reason}`, 'error');
                updateConnectionStatus('å·²æ–­å¼€', 'error');
            });
            
            socket.on('connect_error', (error) => {
                log(`âŒ WebSocketè¿æ¥é”™è¯¯: ${error.message}`, 'error');
                updateConnectionStatus('è¿æ¥é”™è¯¯', 'error');
            });
            
            socket.on('new-order', (data) => {
                log(`ğŸ‰ æ”¶åˆ°æ–°è®¢å•äº‹ä»¶: ${JSON.stringify(data)}`, 'success');
                loadOrders();
            });
            
            socket.on('order-status-change', (data) => {
                log(`ğŸ“‹ è®¢å•çŠ¶æ€å˜æ›´äº‹ä»¶: ${JSON.stringify(data)}`, 'info');
                loadOrders();
            });
            
            socket.onAny((event, ...args) => {
                log(`ğŸ”” æ”¶åˆ°äº‹ä»¶: ${event} - ${JSON.stringify(args)}`, 'info');
            });
        }
        
        function disconnectWebSocket() {
            if (socket) {
                socket.disconnect();
                socket = null;
            }
        }
        
        function joinProductionRoom() {
            if (socket && socket.connected) {
                log('åŠ å…¥åˆ¶ä½œç«¯æˆ¿é—´...');
                socket.emit('join-production', {});
            } else {
                log('è¯·å…ˆè¿æ¥WebSocket', 'error');
            }
        }
        
        function loadOrders() {
            log('åŠ è½½è®¢å•...');
            fetch('http://localhost:3003/api/orders/admin/all')
                .then(response => response.json())
                .then(data => {
                    log(`ğŸ“¦ æ”¶åˆ°è®¢å•æ•°æ®: ${JSON.stringify(data)}`);
                    
                    let orders = [];
                    if (data.code === 200) {
                        orders = data.data?.list || [];
                    } else {
                        orders = data?.list || data || [];
                    }
                    
                    log(`ğŸ“‹ è®¢å•æ€»æ•°: ${orders.length}`, 'success');
                    updateOrderList(orders);
                })
                .catch(error => {
                    log(`âŒ åŠ è½½è®¢å•å¤±è´¥: ${error.message}`, 'error');
                });
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿æ¥
        window.onload = function() {
            connectWebSocket();
            setTimeout(joinProductionRoom, 1000);
            setTimeout(loadOrders, 1500);
        };
    </script>
</body>
</html>