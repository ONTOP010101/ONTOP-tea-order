# 解决订单保留48小时问题和提升加载速度

## 一、解决订单保留48小时问题

### 问题分析

根据代码分析，关闭浏览器后订单记录丢失的原因是：

1. **会话ID存储方式**：会话ID存储在 `sessionStorage` 中
2. **sessionStorage特性**：关闭浏览器标签页或窗口时会自动清空
3. **订单关联机制**：未登录用户的订单通过会话ID关联
4. **订单查询流程**：获取订单列表时需要提供会话ID

### 具体原因

1. **订单创建**：
   - 客户端调用 `createOrder` 函数创建订单
   - 自动添加会话ID：`sessionId: getSessionId()`
   - 服务器端将会话ID存储到订单记录中

2. **订单查询**：
   - 未登录时调用 `/orders/admin/all` 接口
   - 添加会话ID参数：`sessionId: getSessionId()`
   - 服务器端根据会话ID筛选订单

3. **会话ID丢失**：
   - 关闭浏览器后，`sessionStorage` 被清空
   - 重新打开浏览器时生成新的会话ID
   - 无法查询到之前会话ID关联的订单

### 解决方案

#### 核心修改

1. **修改会话ID存储方式**：从 `sessionStorage` 改为 `localStorage`，确保关闭浏览器后会话ID不丢失
2. **添加订单过期机制**：服务器端添加订单过期清理功能，删除超过48小时的订单

#### 具体修改步骤

##### 1. 修改会话管理工具

- **文件**：`apps/h5-client/src/utils/session.ts`
- **修改**：将 `sessionStorage` 改为 `localStorage`
- **内容**：
  ```typescript
  // 获取会话ID，如果不存在则生成新的
  export const getSessionId = (): string => {
    let sessionId = localStorage.getItem('sessionId');
    if (!sessionId) {
      sessionId = generateSessionId();
      localStorage.setItem('sessionId', sessionId);
    }
    return sessionId;
  };

  // 清除会话ID
  export const clearSessionId = (): void => {
    localStorage.removeItem('sessionId');
  };

  // 检查是否有会话ID
  export const hasSessionId = (): boolean => {
    return !!localStorage.getItem('sessionId');
  };
  ```

##### 2. 服务器端添加订单过期清理

- **文件**：`apps/server/src/modules/order/order.service.ts`
- **修改**：添加过期清理方法
- **内容**：
  ```typescript
  // 清理过期订单（超过48小时）
  async clearExpiredOrders(): Promise<void> {
    const expirationTime = new Date();
    expirationTime.setHours(expirationTime.getHours() - 48);
    
    return this.orderRepository.delete({
      createdAt: {
        $lt: expirationTime
      }
    });
  }
  ```

##### 3. 修改订单查询逻辑

- **文件**：`apps/server/src/modules/order/order.controller.ts`
- **修改**：在查询订单时添加时间过滤，只返回48小时内的订单
- **内容**：
  ```typescript
  @Get('/admin/all')
  async getAllOrders(
    @Query('sessionId') sessionId?: string
  ): Promise<Order[]> {
    const query: any = {};
    
    if (sessionId) {
      query.sessionId = sessionId;
    }
    
    // 添加时间过滤，只返回48小时内的订单
    const expirationTime = new Date();
    expirationTime.setHours(expirationTime.getHours() - 48);
    query.createdAt = {
      $gte: expirationTime
    };
    
    return this.orderService.findAll(query);
  }
  ```

## 二、提升加载速度

### 问题分析

根据代码分析，加载速度慢的原因主要包括：

1. **资源加载**：未优化的CSS和JavaScript资源
2. **图片加载**：未优化的图片和缓存策略
3. **网络请求**：未优化的API调用和缓存
4. **代码分割**：未实现路由级别的代码分割

### 解决方案

#### 前端优化

##### 1. 资源加载优化

- **文件**：`apps/h5-client/vite.config.ts`
- **修改**：配置Vite构建选项，优化资源加载
- **内容**：
  ```typescript
  import { defineConfig } from 'vite'
  import vue from '@vitejs/plugin-vue'
  import path from 'path'

  export default defineConfig({
    plugins: [vue()],
    resolve: {
      alias: {
        '@': path.resolve(__dirname, './src')
      }
    },
    build: {
      target: 'es2015',
      minify: 'terser',
      terserOptions: {
        compress: {
          drop_console: true,
          drop_debugger: true
        }
      },
      cssCodeSplit: true,
      sourcemap: false,
      rollupOptions: {
        output: {
          manualChunks: {
            vendor: ['vue', 'vue-router', 'pinia'],
            vant: ['vant'],
            i18n: ['vue-i18n']
          }
        }
      }
    }
  })
  ```

##### 2. 图片加载优化

- **文件**：`apps/server/src/main.ts`
- **修改**：配置静态文件服务的缓存策略
- **内容**：
  ```typescript
  // 静态文件服务 - 用于访问上传的图片
  app.useStaticAssets(join(__dirname, '..', 'uploads'), {
    prefix: '/uploads/',
    setHeaders: (res, path) => {
      if (path.endsWith('.jpg') || path.endsWith('.jpeg') || path.endsWith('.png') || path.endsWith('.gif')) {
        res.setHeader('Cache-Control', 'public, max-age=86400'); // 24小时缓存
      }
    }
  });
  ```

##### 3. 代码分割

- **文件**：`apps/h5-client/src/router/index.ts`
- **修改**：实现路由级别的代码分割
- **内容**：
  ```typescript
  import { createRouter, createWebHistory } from 'vue-router'
  import type { RouteRecordRaw } from 'vue-router'

  const routes: RouteRecordRaw[] = [
    {
      path: '/',
      redirect: '/home'
    },
    {
      path: '/home',
      name: 'Home',
      component: () => import('../views/Home.vue')
    },
    {
      path: '/category',
      name: 'Category',
      component: () => import('../views/Category.vue')
    },
    {
      path: '/product/:id',
      name: 'Product',
      component: () => import('../views/ProductDetail.vue')
    },
    {
      path: '/cart',
      name: 'Cart',
      component: () => import('../views/Cart.vue')
    },
    {
      path: '/order/:id',
      name: 'OrderDetail',
      component: () => import('../views/OrderDetail.vue')
    },
    {
      path: '/order-list',
      name: 'OrderList',
      component: () => import('../views/OrderList.vue')
    },
    {
      path: '/profile',
      name: 'Profile',
      component: () => import('../views/Profile.vue')
    },
    {
      path: '/login',
      name: 'Login',
      component: () => import('../views/Login.vue')
    },
    {
      path: '/:pathMatch(.*)*',
      redirect: '/home'
    }
  ]

  const router = createRouter({
    history: createWebHistory(),
    routes
  })

  export default router
  ```

##### 4. 预加载关键资源

- **文件**：`apps/h5-client/index.html`
- **修改**：添加预加载和预连接
- **内容**：
  ```html
  <!DOCTYPE html>
  <html lang="zh-CN">
    <head>
      <meta charset="UTF-8">
      <link rel="icon" type="image/svg+xml" href="/vite.svg">
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
      <meta name="theme-color" content="#ee0a24">
      <title>悦享茶歇</title>
      <!-- 预连接到API服务器 -->
      <link rel="preconnect" href="/api">
    </head>
    <body>
      <div id="app"></div>
      <script type="module" src="/src/main.ts"></script>
    </body>
  </html>
  ```

#### 后端优化

##### 1. API响应优化

- **文件**：`apps/server/src/common/interceptors/transform.interceptor.ts`
- **修改**：优化响应格式，减少不必要的数据

##### 2. 数据库查询优化

- **文件**：`apps/server/src/modules/product/product.service.ts`
- **修改**：添加查询缓存

## 预期效果

### 订单保留48小时

- **关闭浏览器后**：会话ID保存在 `localStorage` 中，不会丢失
- **重新打开浏览器**：使用相同的会话ID，可查询到48小时内的订单
- **订单过期**：超过48小时的订单会被自动清理
- **用户体验**：订单记录在48小时内持久化，不会因关闭浏览器而丢失
- **系统性能**：自动清理过期订单，保持数据库清洁

### 提升加载速度

- **首屏加载**：通过代码分割和资源优化，减少首屏加载时间
- **图片加载**：通过缓存策略，减少图片重复加载
- **路由切换**：通过懒加载，提高路由切换速度
- **API响应**：通过缓存和优化，提高API响应速度
- **整体性能**：通过各种优化手段，提升整体加载速度和用户体验

## 实施步骤

1. **修改会话管理工具**：将 `sessionStorage` 改为 `localStorage`
2. **修改服务器端**：
   - 添加订单过期清理函数
   - 修改订单查询逻辑
   - 优化静态文件服务缓存策略
3. **修改前端**：
   - 配置Vite构建选项
   - 实现路由级别的代码分割
   - 添加预加载和预连接
4. **测试验证**：
   - 创建订单后关闭浏览器
   - 重新打开浏览器查看订单记录
   - 确认订单记录仍然存在
   - 测试加载速度是否有明显提升

此修改不会影响任何样式，只会解决订单保留问题和提升加载速度。所有修改都经过精心设计，确保系统稳定性和用户体验。