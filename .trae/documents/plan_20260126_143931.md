## 4. 自动化回滚脚本完善

### 脚本功能
- 支持代码回滚到指定Git提交ID
- 支持从数据库备份文件恢复数据
- 自动停止并重启所有服务
- 包含完整的错误处理和日志记录
- 支持参数化操作，便于快速执行

### 脚本实现
```cmd
@echo off
chcp 65001 >nul
setlocal enabledelayedexpansion

echo ===============================================
echo          自动化回滚脚本 v1.0
echo ===============================================

:: 检查参数
if "%1"=="" (
    echo 错误：请提供回滚的Git提交ID
    echo 使用方法：rollback.bat 提交ID 数据库备份文件.sql
    echo 示例：rollback.bat f2dd4c3 "C:\backup\tea_order_system_20260126_2229.sql"
    pause
    exit /b 1
)

if "%2"=="" (
    echo 错误：请提供数据库备份文件路径
    echo 使用方法：rollback.bat 提交ID 数据库备份文件.sql
    pause
    exit /b 1
)

:: 配置项目路径
set "PROJECT_DIR=C:\Users\Administrator\ONTOP-tea-order"
set "SERVER_DIR=%PROJECT_DIR%\apps\server"
set "ADMIN_DIR=%PROJECT_DIR%\apps\admin-panel"
set "H5_DIR=%PROJECT_DIR%\apps\h5-client"

:: 配置MySQL信息
set "MYSQL_BIN=C:\Program Files\MySQL\MySQL Server 8.4\bin"
set "MYSQL_USER=root"
set "MYSQL_PASSWORD=123456"
set "MYSQL_DATABASE=tea_order_system"

:: 配置服务名称
set "MYSQL_SERVICE=MySQL84"

:: 配置回滚参数
set "COMMIT_ID=%1"
set "DB_BACKUP_FILE=%2"

:: 记录开始时间
set "START_TIME=%time%"
echo 回滚开始时间：%START_TIME%
echo 回滚提交ID：%COMMIT_ID%
echo 数据库备份：%DB_BACKUP_FILE%
echo 项目路径：%PROJECT_DIR%
echo ===============================================

:: 1. 检查Git仓库
if not exist "%PROJECT_DIR%\.git" (
    echo 错误：不是Git仓库，请检查项目路径
    pause
    exit /b 1
)

:: 2. 停止所有Node.js服务
echo [1/5] 停止所有Node.js服务...
taskkill /f /im node.exe 2>nul
echo 已停止所有Node.js服务

:: 3. 回滚代码
echo [2/5] 回滚代码到提交 %COMMIT_ID%...
cd "%PROJECT_DIR%"
git reset --hard %COMMIT_ID%
if %ERRORLEVEL% == 0 (
    echo 代码回滚成功
) else (
    echo 错误：代码回滚失败
    pause
    exit /b 1
)

:: 4. 检查MySQL服务状态
echo [3/5] 检查MySQL服务状态...
sc query "%MYSQL_SERVICE%" | find "RUNNING" >nul
if %ERRORLEVEL% == 0 (
    echo MySQL服务正在运行
) else (
    echo MySQL服务未运行，尝试启动...
    net start "%MYSQL_SERVICE%" >nul 2>&1
    if %ERRORLEVEL% == 0 (
        echo MySQL服务启动成功
    ) else (
        echo 错误：MySQL服务启动失败
        pause
        exit /b 1
    )
)

:: 5. 恢复数据库
echo [4/5] 恢复数据库...
"%MYSQL_BIN%\mysql.exe" -u%MYSQL_USER% -p%MYSQL_PASSWORD% %MYSQL_DATABASE% < "%DB_BACKUP_FILE%"
if %ERRORLEVEL% == 0 (
    echo 数据库恢复成功
) else (
    echo 错误：数据库恢复失败，请检查备份文件
    pause
    exit /b 1
)

:: 6. 重启服务
echo [5/5] 重启所有服务...

:: 重启后端服务
echo 启动后端服务...
start "后端服务" cmd /k "cd %SERVER_DIR% && npm run start:dev"

:: 重启管理后台
echo 启动管理后台...
start "管理后台" cmd /k "cd %ADMIN_DIR% && npm run dev"

:: 重启移动端
echo 启动移动端...
start "移动端" cmd /k "cd %H5_DIR% && npm run dev"

echo 所有服务重启完成

:: 记录结束时间
set "END_TIME=%time%"
echo ===============================================
echo 回滚完成！
echo 开始时间：%START_TIME%
echo 结束时间：%END_TIME%
echo 回滚提交ID：%COMMIT_ID%
echo 数据库备份：%DB_BACKUP_FILE%
echo ===============================================
echo 访问地址：
echo 后端服务：http://localhost:3003
echo 管理后台：http://localhost:3005
echo 移动端：http://localhost:5174
echo ===============================================
pause
```

### 使用说明
1. 将脚本保存为 `rollback.bat`，放在项目根目录
2. 确保已安装Git和MySQL命令行工具
3. 使用管理员权限运行命令提示符
4. 执行回滚命令：
   ```cmd
   rollback.bat 提交ID 数据库备份文件.sql
   ```
5. 示例：
   ```cmd
   rollback.bat f2dd4c3 "C:\Users\Administrator\ONTOP-tea-order\SJKBF\tea_order_system_20260126_2229.sql"
   ```

### 脚本特点
- 支持参数化操作，便于快速执行
- 包含完整的错误处理和状态反馈
- 自动停止并重启所有服务
- 记录回滚过程，便于调试
- 清晰的使用说明和示例
- 适用于Windows系统

### 注意事项
1. 回滚操作不可逆，请谨慎使用
2. 建议在测试环境先验证脚本
3. 确保数据库备份文件与提交ID对应
4. 使用管理员权限运行脚本
5. 回滚前确保所有服务可以停止

这个脚本将帮助您在出现问题时快速回滚到稳定版本，保障系统的可用性和数据安全。